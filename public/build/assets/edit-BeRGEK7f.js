import{u as Ve,r as x,j as e,H as qe}from"./app-CQY01_Hl.js";import{B as Ee}from"./badge-BSQev8u6.js";import{B as y}from"./button-BluykqL-.js";import{C as q}from"./checkbox-DkHIgEri.js";import{I as g}from"./input-Cr4PK9yE.js";import{L as n}from"./label-EGOmbW92.js";import{R as Ie}from"./RichTextEditor-Dd-Qo10T.js";import{d as E,S as I,a as R,b as B,c as F}from"./select-BC9YTAFF.js";import{T as ee}from"./textarea-D_VMQaJc.js";import{A as Re}from"./app-layout-BFesc2IZ.js";import{t as Be}from"./index-7ujUmCNw.js";import{t as f}from"./index-Du1opkJh.js";import{M as Fe}from"./map-pin-DTPCjSzE.js";import{S as se}from"./search-DHamVD2G.js";import{C as U}from"./index-DK901XDU.js";import{T as Ue}from"./trash-2-Bwip0iwY.js";import{P as te}from"./plus-CdtyGC9V.js";import{X as A}from"./x-C5aSEyQM.js";import{C as re}from"./cloud-upload-BBFD_HwX.js";import{U as Ae}from"./users-DZBot_VH.js";import{A as Ge}from"./arrow-left-lshHOtOt.js";import{A as ze}from"./arrow-right-C8apJlAB.js";import{S as He}from"./save-BZ2o4m_R.js";import"./app-CEC-CZWY.js";import"./utils-D0Zg16Wk.js";import"./index-BZBSjhWP.js";import"./index-Cx_4zReh.js";import"./index-B4_eF53t.js";import"./createLucideIcon-DRgLANJZ.js";import"./avatar-D1tWo-p_.js";import"./index-Dhq0cQs_.js";import"./index-CMWG4mbA.js";import"./index-D9s5CDJa.js";import"./app-logo-icon-Dr_4Q5D8.js";import"./index-31lGrPGR.js";import"./index-gSLmiL6w.js";import"./index-DaohGxKX.js";import"./index-2FGh3n-F.js";import"./index-CGelz8kl.js";import"./file-text-BL_MquKf.js";function $s({tour:b,template:G,categories:ae,policies:ie,guides:z,countries:j}){const o=G||b;console.log("Edit Component Mount - tourData:",o),console.log("Edit Component Mount - Schedules from prop:",o.schedules),G?.instances;const{data:a,setData:c,post:ne,processing:H,errors:d}=Ve({_method:"PUT",category_id:String(o.category_id),province_id:String(o.province_id||""),title:o.title,day:o.day,night:o.night,thumbnail:null,description:o.description||"",short_description:o.short_description||"",price_adult:o.price_adult??"",price_children:o.price_children??"",gallery_images:[],schedules:(o.schedules||[]).map(s=>({name:s.name,description:s.description||"",destination_id:String(s.destination_id),date:s.date})),tour_services:(o.tour_services||[]).map(s=>({service_id:String(s.service_id),service_name:s.service?.name,quantity:s.quantity,unit:s.unit,price_unit:s.price_unit,price_total:s.price_total,description:s.description||""})),policy_ids:(o.tour_policies||[]).map(s=>s.policy_id),guide_ids:(o.trip_assignments||[]).filter(s=>!s.tour_instance_id).map(s=>s.user_id)||[],pricing_config:o.pricing_config||null}),le=x.useMemo(()=>{if(!o.province_id)return"";const s=j.find(t=>t.provinces?.some(r=>String(r.id)===String(o.province_id)));return s?String(s.id):""},[o.province_id,j]),[w,ce]=x.useState(le),[M,de]=x.useState(""),[$,K]=x.useState(""),[m,W]=x.useState(1),[oe,O]=x.useState(!0),he=[{id:1,title:"Thông tin chung"},{id:2,title:"Lịch trình"},{id:3,title:"Nội dung"},{id:4,title:"Hình ảnh"},{id:5,title:"Dịch vụ & Khác"},{id:6,title:"Tính giá & LN"}],[i,v]=x.useState(o.pricing_config||{guestEstimate:10,guideSalaryDay:5e5,insurancePerPax:2e4,managementFee:0,profitMargin:20,taxRate:8,childrenPercentage:75}),me=x.useMemo(()=>j.filter(s=>s.name.toLowerCase().includes(M.toLowerCase())),[j,M]),xe=x.useMemo(()=>(j.find(r=>String(r.id)===w)?.provinces||[]).filter(r=>r.name.toLowerCase().includes($.toLowerCase())),[j,w,$]),N=x.useMemo(()=>{for(const s of j){const t=s.provinces?.find(r=>String(r.id)===a.province_id);if(t)return t}return null},[a.province_id,j]),S=x.useMemo(()=>N?.destinations||[],[N]),D=x.useMemo(()=>N?.providers?N.providers.flatMap(s=>(s.services||[]).map(t=>({...t,displayName:`${t.name} - ${s.name}`}))):[],[N]),u=x.useMemo(()=>{const s=a.tour_services.reduce(($e,De)=>$e+De.price_total,0),t=Math.ceil(s/i.guestEstimate),r=Math.ceil(i.guideSalaryDay*a.day/i.guestEstimate),l=t+r+i.insurancePerPax,h=l+i.managementFee,p=h*(1+i.profitMargin/100),C=Math.ceil(p*(1+i.taxRate/100)),Me=Math.ceil(C/1e3)*1e3;return{totalServiceCost:s,serviceCostPerPax:t,guideCostPerPax:r,baseCost:l,costWithMgmt:h,priceBeforeTax:p,finalPrice:Me}},[a.tour_services,a.day,i]),ge=()=>{c(s=>({...s,price_adult:u.finalPrice,price_children:Math.ceil(u.finalPrice*(i.childrenPercentage/100)/1e3)*1e3,pricing_config:i})),f.success("Đã áp dụng giá tính toán vào form!")},_=x.useMemo(()=>{const s=Number(a.day),t=Number(a.night);return t>s?"Số đêm không được lớn hơn số ngày.":s-t>1?"Số đêm không được ít hơn số ngày quá 1 (chênh tối đa 1).":""},[a.night,a.day]),T=x.useMemo(()=>Number(a.day)>0&&a.schedules.length!==Number(a.day)?`Cần ${a.day} ngày lịch trình, hiện có ${a.schedules.length}.`:"",[a.day,a.schedules.length]),ue=s=>{switch(s){case 1:return a.category_id?a.title?Number(a.day)<1?"Số ngày phải lớn hơn 0":_||!0:"Vui lòng nhập tên tour":"Vui lòng chọn danh mục";case 2:return a.province_id?T||!0:"Vui lòng chọn Tỉnh/Thành phố";case 3:return a.short_description?!0:"Vui lòng nhập mô tả ngắn";case 4:return!0;case 5:return!0;case 6:return a.price_adult?!0:"Vui lòng nhập giá người lớn";default:return!0}},Q=()=>{const s=ue(m);s===!0?(W(t=>Math.min(t+1,6)),window.scrollTo(0,0),m===5&&(O(!1),setTimeout(()=>O(!0),1e3))):f.error(s)},pe=()=>{W(s=>Math.max(s-1,1)),window.scrollTo(0,0)},be=s=>{ce(s),c(t=>({...t,province_id:"",schedules:[],tour_services:[]})),K("")},je=s=>{a.province_id!==s&&c(t=>({...t,province_id:s,schedules:[],tour_services:[]}))},ve=(s,t)=>{if(t){const r={name:`Tham quan ${s.name}`,description:s.description||`Khám phá ${s.name}`,destination_id:String(s.id),date:a.schedules.length+1};c("schedules",[...a.schedules,r])}else{const r=a.schedules.filter(l=>l.destination_id!==String(s.id));c("schedules",r)}},Ne=s=>{const t=Number(s);c(r=>{const l=[...r.schedules];if(t>l.length)for(let h=l.length;h<t;h++)l.push({name:`Ngày ${h+1}: `,description:"",destination_id:"",date:h+1});else t<l.length&&(l.length=t>0?t:0);return{...r,day:t,schedules:l}})},ye=b.thumbnail&&!b.thumbnail.startsWith("http")?`/storage/${b.thumbnail}`:b.thumbnail,[X,J]=x.useState(ye||null),[V,Y]=x.useState([]),P=x.useRef(null),fe=s=>{const t=s.target.files?.[0];t&&(J(URL.createObjectURL(t)),c("thumbnail",t))},we=s=>{s.stopPropagation(),J(null),c("thumbnail",null),P.current&&(P.current.value="")},Ce=s=>{const t=Array.from(s.target.files||[]);if(t.length>0){const r=t.map(l=>URL.createObjectURL(l));Y(l=>[...l,...r]),c("gallery_images",[...a.gallery_images,...t])}},Se=s=>{const t=[...V];t.splice(s,1),Y(t);const r=[...a.gallery_images];r.splice(s,1),c("gallery_images",r)},_e=()=>{if(!a.province_id){f.error("Vui lòng chọn Tỉnh/Thành phố ở phần trên trước.");return}c("schedules",[...a.schedules,{name:"",description:"",destination_id:"",date:a.schedules.length+1}])},Te=s=>{const t=[...a.schedules];t.splice(s,1),c("schedules",t)},k=(s,t,r)=>{const l=[...a.schedules];l[s]={...l[s],[t]:r},c("schedules",l)},Pe=()=>{if(!a.province_id){f.error("Vui lòng chọn Tỉnh/Thành phố trước khi thêm dịch vụ.");return}c("tour_services",[...a.tour_services,{service_id:"",quantity:1,unit:"Lần",price_unit:0,price_total:0,description:""}])},ke=s=>{const t=[...a.tour_services];t.splice(s,1),c("tour_services",t)},L=(s,t,r)=>{const l=[...a.tour_services],h={...l[s]};if(h[t]=r,t==="service_id"){const p=D.find(C=>String(C.id)===r);p&&(h.price_unit=Number(p.price),h.unit=p.unit||"Lần",h.service_name=p.name,h.price_total=h.quantity*h.price_unit)}if(t==="quantity"||t==="price_unit"){const p=t==="quantity"?Number(r):h.quantity,C=t==="price_unit"?Number(r):h.price_unit;h.price_total=p*C}l[s]=h,c("tour_services",l)},Z=(s,t)=>{const r=a[s];r.includes(t)?c(s,r.filter(l=>l!==t)):c(s,[...r,t])},Le=s=>{if(s.preventDefault(),a.pricing_config=i,m<6){Q();return}ne(Be.update(o.id).url,{forceFormData:!0,onError:t=>{console.error("Validation Errors:",t),f.error("Có lỗi xảy ra. Vui lòng kiểm tra lại dữ liệu.");const r=Object.keys(t)[0];r&&f.error(t[r])},onSuccess:()=>{f.success("Cập nhật tour thành công!")}})};return x.useEffect(()=>{const s=document.getElementById("active-step");s&&s.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},[m]),e.jsxs(Re,{breadcrumbs:[{title:"Chỉnh sửa Tour",href:"#"}],children:[e.jsx(qe,{title:`Chỉnh sửa: ${o.title}`}),e.jsx("div",{className:"min-h-screen bg-gray-50 p-8 pb-32",children:e.jsxs("form",{onSubmit:Le,className:"mx-auto max-w-7xl space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Chỉnh sửa Tour"}),e.jsxs("div",{className:"text-sm font-medium text-gray-500",children:["Bước ",m,"/6"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mb-6",children:e.jsx("div",{className:"bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-in-out",style:{width:`${m/6*100}%`}})}),e.jsx("div",{className:"flex justify-between items-center mb-6 overflow-x-auto pb-2",children:he.map(s=>e.jsxs("div",{id:s.id===m?"active-step":void 0,className:`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors
                                    ${s.id===m?"bg-blue-100 text-blue-700 border border-blue-200":s.id<m?"text-green-600 bg-green-50":"text-gray-400 bg-gray-50"}`,children:[e.jsx("div",{className:`w-6 h-6 rounded-full flex items-center justify-center text-xs
                                        ${s.id===m?"bg-blue-600 text-white":s.id<m?"bg-green-500 text-white":"bg-gray-300 text-white"}`,children:s.id}),s.title]},s.id))})]}),e.jsx("div",{className:m===1?"block":"hidden",children:e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 border-b pb-4 text-xl font-semibold text-gray-800",children:"1. Thông tin cơ bản"}),e.jsx("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(n,{children:["Danh mục ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(E,{onValueChange:s=>c("category_id",s),value:a.category_id,children:[e.jsx(I,{className:d.category_id?"border-red-500":"",children:e.jsx(R,{placeholder:"-- Chọn danh mục --"})}),e.jsx(B,{children:ae.map(s=>e.jsx(F,{value:String(s.id),children:s.title},s.id))})]}),d.category_id&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.category_id})]}),e.jsxs("div",{children:[e.jsxs(n,{children:["Tên Tour ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(g,{value:a.title,onChange:s=>c("title",s.target.value),placeholder:"VD: Tour Khám Phá...",className:d.title?"border-red-500":""}),d.title&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.title})]})]})}),e.jsxs("div",{className:"mt-6 grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(n,{children:"Số ngày"}),e.jsx(g,{type:"number",min:"1",value:a.day,onChange:s=>Ne(s.target.value),onFocus:s=>s.target.select()})]}),e.jsxs("div",{children:[e.jsx(n,{children:"Số đêm"}),e.jsx(g,{type:"number",min:"0",value:a.night,onChange:s=>c("night",Number(s.target.value)),onFocus:s=>s.target.select()}),_&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:_})]})]})]})}),e.jsx("div",{className:m===2?"block":"hidden",children:e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 border-b pb-4 text-xl font-semibold text-gray-800",children:"2. Địa điểm & Lịch trình"}),e.jsxs("div",{className:"mb-8",children:[e.jsx(n,{className:"mb-2 block text-base font-semibold text-blue-700",children:"Chỉnh sửa Địa điểm (Lưu ý: Chọn lại tỉnh sẽ reset lịch trình)"}),e.jsxs("div",{className:"grid h-[450px] grid-cols-1 overflow-hidden rounded-lg border bg-white shadow-sm md:grid-cols-3",children:[e.jsxs("div",{className:"flex flex-col border-r",children:[e.jsxs("div",{className:"flex items-center gap-2 border-b bg-gray-50 p-3 font-semibold text-gray-700",children:[e.jsx(Fe,{className:"h-4 w-4"})," Quốc gia"]}),e.jsx("div",{className:"border-b p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute top-2.5 left-2 h-4 w-4 text-gray-500"}),e.jsx(g,{placeholder:"Tìm quốc gia...",className:"h-9 pl-8",value:M,onChange:s=>de(s.target.value)})]})}),e.jsx("div",{className:"scrollbar-thin scrollbar-thumb-gray-200 flex-1 space-y-1 overflow-y-auto p-2",children:me.map(s=>e.jsxs("button",{type:"button",onClick:()=>be(String(s.id)),className:`flex w-full items-center justify-between rounded-md px-3 py-2 text-left text-sm transition-colors ${String(s.id)===w?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"}`,children:[e.jsx("span",{children:s.name}),String(s.id)===w&&e.jsx(U,{className:"h-4 w-4"})]},s.id))})]}),e.jsxs("div",{className:"flex flex-col border-r",children:[e.jsx("div",{className:"border-b bg-gray-50 p-3 font-semibold text-gray-700",children:"Tỉnh / Thành phố"}),e.jsx("div",{className:"border-b p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute top-2.5 left-2 h-4 w-4 text-gray-500"}),e.jsx(g,{placeholder:"Tìm tỉnh thành...",className:"h-9 pl-8",value:$,onChange:s=>K(s.target.value),disabled:!w})]})}),e.jsxs("div",{className:"scrollbar-thin scrollbar-thumb-gray-200 flex-1 space-y-1 overflow-y-auto p-2",children:[!w&&e.jsx("div",{className:"py-4 text-center text-sm text-gray-400",children:"← Chọn quốc gia trước"}),xe.map(s=>e.jsxs("button",{type:"button",onClick:()=>je(String(s.id)),className:`flex w-full items-center justify-between rounded-md px-3 py-2 text-left text-sm transition-colors ${String(s.id)===a.province_id?"bg-blue-100 font-medium text-blue-700":"text-gray-700 hover:bg-gray-100"}`,children:[s.name,String(s.id)===a.province_id&&e.jsx(U,{className:"h-4 w-4"})]},s.id))]})]}),e.jsxs("div",{className:"flex flex-col bg-gray-50/50",children:[e.jsx("div",{className:"border-b bg-gray-50 p-3 font-semibold text-gray-700",children:"Địa điểm du lịch"}),e.jsxs("div",{className:"scrollbar-thin scrollbar-thumb-gray-200 flex-1 space-y-3 overflow-y-auto p-3",children:[!a.province_id&&e.jsx("div",{className:"py-4 text-center text-sm text-gray-400",children:"← Chọn tỉnh thành để xem địa điểm"}),a.province_id&&S.length===0&&e.jsx("div",{className:"py-4 text-center text-sm text-gray-400",children:"Chưa có dữ liệu địa điểm"}),S.map(s=>{const t=a.schedules.some(r=>r.destination_id===String(s.id));return e.jsxs("div",{className:`flex cursor-pointer items-start space-x-3 rounded-md border p-3 transition-all ${t?"border-green-200 bg-green-50":"bg-white hover:border-blue-300"}`,children:[e.jsx(q,{id:`dest-${s.id}`,checked:t,onCheckedChange:r=>ve(s,r)}),e.jsxs("div",{className:"grid gap-1.5 leading-none",children:[e.jsx("label",{htmlFor:`dest-${s.id}`,className:"cursor-pointer text-sm leading-none font-medium",children:s.name}),e.jsx("p",{className:"line-clamp-2 text-xs text-gray-500",children:s.description||"Không có mô tả"})]})]},s.id)})]})]})]}),d.province_id&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:d.province_id})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"scrollbar-thin max-h-[600px] space-y-4 overflow-y-auto pr-2",children:[a.schedules.length===0&&e.jsx("div",{className:"flex h-32 flex-col items-center justify-center rounded-lg border border-dashed bg-gray-50 text-gray-500",children:e.jsx("p",{children:"Chưa có lịch trình nào."})}),T&&e.jsx("div",{className:"rounded border border-yellow-200 bg-yellow-50 p-3 text-sm text-yellow-700",children:T}),a.schedules.map((s,t)=>e.jsxs("div",{className:"relative rounded-lg border border-gray-200 bg-gray-50 p-4 hover:border-blue-300 hover:shadow-sm",children:[e.jsx("button",{type:"button",onClick:()=>Te(t),className:"absolute top-4 right-4 text-gray-400 hover:text-red-500",children:e.jsx(Ue,{className:"h-5 w-5"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-12",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Ngày"}),e.jsx(g,{type:"number",min:"1",className:"bg-white",value:s.date,onChange:r=>k(t,"date",r.target.value)})]}),e.jsxs("div",{className:"md:col-span-6",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Hoạt động"}),e.jsx(g,{className:"bg-white font-medium",placeholder:"VD: Tham quan...",value:s.name,onChange:r=>k(t,"name",r.target.value)})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsxs(n,{className:"text-xs text-gray-500",children:["Địa điểm ",N?`(${N.name})`:""]}),e.jsxs(E,{value:String(s.destination_id),onValueChange:r=>k(t,"destination_id",r),children:[e.jsx(I,{className:"bg-white",children:e.jsx(R,{placeholder:"Chọn điểm đến"})}),e.jsx(B,{children:S.length>0?S.map(r=>{const l=a.schedules.some((h,p)=>p!==t&&String(h.destination_id)===String(r.id));return e.jsxs(F,{value:String(r.id),disabled:l,children:[r.name," ",l?"(Đã chọn)":""]},r.id)}):e.jsx("div",{className:"p-2 text-center text-xs text-gray-500",children:"Chưa có địa điểm nào"})})]})]}),e.jsxs("div",{className:"md:col-span-12",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Chi tiết"}),e.jsx(ee,{className:"bg-white",rows:2,value:s.description,onChange:r=>k(t,"description",r.target.value)})]})]})]},t))]}),e.jsx("div",{className:"mt-4 flex justify-center border-t pt-2",children:e.jsxs(y,{type:"button",size:"sm",onClick:_e,className:"w-full md:w-auto",children:[e.jsx(te,{className:"mr-1 h-4 w-4"})," Thêm Ngày"]})})]})]})}),e.jsx("div",{className:m===3?"block":"hidden",children:e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 border-b pb-4 text-xl font-semibold text-gray-800",children:"3. Nội dung mô tả"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(n,{className:"mb-2 block font-medium",children:"Mô tả ngắn (Tóm tắt)"}),e.jsx(ee,{rows:3,value:a.short_description,onChange:s=>c("short_description",s.target.value),className:d.short_description?"border-red-500":""}),d.short_description&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.short_description})]}),e.jsxs("div",{children:[e.jsx(n,{className:"mb-2 block font-medium",children:"Mô tả chi tiết"}),e.jsx("div",{className:`rounded-md border ${d.description?"border-red-500":"border-gray-300"}`,children:e.jsx(Ie,{value:a.description,onChange:s=>c("description",s),height:400})}),d.description&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.description})]})]})]})}),e.jsx("div",{className:m===4?"block":"hidden",children:e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 border-b pb-4 text-xl font-semibold text-gray-800",children:"4. Thư viện hình ảnh"}),e.jsxs("div",{className:"grid grid-cols-1 gap-8 md:grid-cols-3",children:[e.jsxs("div",{className:"md:col-span-1",children:[e.jsx(n,{className:"mb-3 block font-medium",children:"Ảnh đại diện"}),e.jsxs("div",{className:`relative flex h-48 w-full cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed bg-gray-50 hover:bg-gray-100 ${d.thumbnail?"border-red-500":"border-gray-300"}`,onClick:()=>P.current?.click(),children:[X?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:X,className:"h-full w-full rounded-lg object-cover"}),e.jsx("button",{type:"button",onClick:we,className:"absolute top-2 right-2 rounded-full bg-red-600 p-1 text-white shadow-sm hover:bg-red-700",children:e.jsx(A,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"text-center",children:[e.jsx(re,{className:"mx-auto mb-2 h-10 w-10 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Tải ảnh lên"})]}),e.jsx("input",{type:"file",ref:P,className:"hidden",accept:"image/*",onChange:fe})]}),d.thumbnail&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.thumbnail})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(n,{className:"mb-3 block font-medium",children:"Bộ sưu tập ảnh"}),e.jsxs("div",{className:"rounded-lg border border-gray-200 p-4",children:[e.jsx("div",{className:"mb-4 flex items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 py-8 hover:bg-gray-100",children:e.jsxs("label",{className:"cursor-pointer text-center",children:[e.jsx(re,{className:"mx-auto mb-2 h-8 w-8 text-gray-400"}),e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Thêm nhiều ảnh"}),e.jsx("input",{type:"file",multiple:!0,className:"hidden",accept:"image/*",onChange:Ce})]})}),V.length>0&&e.jsx("div",{className:"grid grid-cols-4 gap-4 sm:grid-cols-5 md:grid-cols-6 mb-4",children:V.map((s,t)=>e.jsxs("div",{className:"group relative aspect-square overflow-hidden rounded-md border",children:[e.jsx("img",{src:s,className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>Se(t),className:"absolute top-1 right-1 hidden rounded-full bg-red-600 p-0.5 text-white shadow-sm group-hover:block",children:e.jsx(A,{className:"h-3 w-3"})})]},t))}),b.images&&b.images.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx(n,{className:"mb-2 block text-sm font-medium text-gray-700",children:"Ảnh hiện tại (Chỉ xem)"}),e.jsx("div",{className:"grid grid-cols-6 gap-2",children:b.images.map(s=>e.jsx("div",{className:"relative aspect-square overflow-hidden rounded border",children:e.jsx("img",{src:s.img_url.startsWith("http")?s.img_url:`/storage/${s.img_url}`,className:"h-full w-full object-cover",alt:s.alt})},s.id))})]}),d.gallery_images&&e.jsx("p",{className:"mt-2 text-xs text-red-500",children:d.gallery_images})]})]})]})]})}),e.jsx("div",{className:m===5?"block":"hidden",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm md:col-span-3",children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between border-b pb-2",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"5. Dịch vụ đi kèm"}),e.jsxs(y,{type:"button",size:"sm",variant:"outline",onClick:Pe,children:[e.jsx(te,{className:"mr-1 h-4 w-4"})," Thêm Dịch vụ"]})]}),!a.province_id&&e.jsxs("div",{className:"mb-4 rounded border border-yellow-200 bg-yellow-50 p-3 text-sm text-yellow-700",children:["Vui lòng chọn ",e.jsx("strong",{children:"Tỉnh/Thành phố"})," để hiển thị danh sách nhà cung cấp dịch vụ."]}),e.jsx("div",{className:"scrollbar-thin max-h-[600px] space-y-4 overflow-y-auto pr-2",children:a.tour_services.map((s,t)=>e.jsxs("div",{className:"relative flex flex-col gap-4 rounded-lg border bg-gray-50 p-4 hover:border-blue-300 md:flex-row md:items-start",children:[e.jsx("button",{type:"button",onClick:()=>ke(t),className:"absolute -top-2 -right-2 rounded-full border bg-white p-1 text-red-500 shadow-sm hover:bg-red-50",children:e.jsx(A,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Tên dịch vụ"}),e.jsxs(E,{value:s.service_id,onValueChange:r=>L(t,"service_id",r),children:[e.jsx(I,{className:"mt-1 bg-white",children:e.jsx(R,{placeholder:"Chọn dịch vụ..."})}),e.jsx(B,{children:D.length>0?D.map(r=>e.jsx(F,{value:String(r.id),children:r.displayName},r.id)):e.jsx("div",{className:"p-2 text-center text-xs text-gray-500",children:"Không có dịch vụ nào"})})]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"SL"}),e.jsx(g,{type:"number",min:"1",className:"mt-1 bg-white",value:s.quantity,onChange:r=>L(t,"quantity",r.target.value)})]}),e.jsxs("div",{className:"w-24",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Đơn vị"}),e.jsx(g,{className:"mt-1 bg-white",value:s.unit,onChange:r=>L(t,"unit",r.target.value)})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Đơn giá"}),e.jsx(g,{type:"number",className:"mt-1 bg-white",value:s.price_unit,onChange:r=>L(t,"price_unit",r.target.value)})]}),e.jsxs("div",{className:"w-32",children:[e.jsx(n,{className:"text-xs text-gray-500",children:"Thành tiền"}),e.jsx("div",{className:"mt-1 flex h-10 items-center rounded-md border bg-gray-100 px-3 font-bold text-green-600",children:new Intl.NumberFormat("vi-VN",{style:"decimal"}).format(s.price_total)})]})]},t))})]}),e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h3",{className:"mb-4 font-semibold text-gray-800",children:"Chính sách"}),e.jsx("div",{className:"max-h-60 space-y-2 overflow-y-auto pr-2",children:ie.map(s=>e.jsxs("label",{className:"flex cursor-pointer items-start gap-2 rounded border p-2 hover:bg-gray-50",children:[e.jsx(q,{className:"mt-0.5",checked:a.policy_ids.includes(s.id),onCheckedChange:()=>Z("policy_ids",s.id)}),e.jsx("span",{className:"text-sm text-gray-700",children:s.title})]},s.id))})]}),e.jsxs("div",{className:"space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm md:col-span-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5 text-gray-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Hướng dẫn viên"})]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Chọn hướng dẫn viên cho tour này. Các hướng dẫn viên này sẽ được tự động gán cho các chuyến đi mới."}),e.jsx("div",{className:"max-h-60 space-y-2 overflow-y-auto rounded-md border border-gray-200 p-3",children:z.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Chưa có hướng dẫn viên nào trong hệ thống."}):z.map(s=>e.jsxs("div",{className:`flex items-center justify-between rounded-md border p-3 ${s.has_active_tour?"border-amber-200 bg-amber-50":"border-gray-200 bg-white"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{id:`guide-${s.id}`,checked:a.guide_ids.includes(s.id),onCheckedChange:()=>Z("guide_ids",s.id),disabled:s.has_active_tour}),e.jsxs(n,{htmlFor:`guide-${s.id}`,className:`cursor-pointer ${s.has_active_tour?"text-gray-400":"text-gray-700"}`,children:[s.name," (",s.email,")"]})]}),s.has_active_tour&&e.jsx(Ee,{variant:"secondary",className:"bg-amber-100 text-amber-800",children:"Đã có tour"})]},s.id))})]})]})}),e.jsx("div",{className:m===6?"block":"hidden",children:e.jsxs("div",{className:"rounded-lg border border-gray-200 bg-white p-6 shadow-sm",children:[e.jsx("h2",{className:"mb-6 border-b pb-4 text-xl font-semibold text-gray-800",children:"6. Công cụ Tính giá & Lợi nhuận"}),e.jsxs("div",{className:"grid grid-cols-1 gap-8 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-6 rounded-lg bg-gray-50 p-4 border border-gray-200",children:[e.jsx("h3",{className:"font-semibold text-blue-700 uppercase p-2 bg-blue-50 rounded",children:"1. Tham số tính toán"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Số khách dự kiến (Người)"}),e.jsx(g,{type:"number",min:"1",value:i.guestEstimate,onChange:s=>v({...i,guestEstimate:Number(s.target.value)}),className:"bg-white"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Dùng để chia đều chi phí cố định."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Lương Guide/Ngày"}),e.jsx(g,{type:"number",min:"0",value:i.guideSalaryDay,onChange:s=>v({...i,guideSalaryDay:Number(s.target.value)}),className:"bg-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Bảo hiểm/Người"}),e.jsx(g,{type:"number",min:"0",value:i.insurancePerPax,onChange:s=>v({...i,insurancePerPax:Number(s.target.value)}),className:"bg-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Phí quản lý/Người"}),e.jsx(g,{type:"number",min:"0",value:i.managementFee,onChange:s=>v({...i,managementFee:Number(s.target.value)}),className:"bg-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Lợi nhuận mục tiêu (%)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{type:"number",min:"0",max:"100",value:i.profitMargin,onChange:s=>v({...i,profitMargin:Number(s.target.value)}),className:"bg-white"}),e.jsx("span",{className:"font-bold text-gray-600",children:"%"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Thuế VAT (%)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{type:"number",min:"0",max:"100",value:i.taxRate,onChange:s=>v({...i,taxRate:Number(s.target.value)}),className:"bg-white"}),e.jsx("span",{className:"font-bold text-gray-600",children:"%"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Tỷ lệ giá Trẻ em (%)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{type:"number",min:"0",max:"100",value:i.childrenPercentage,onChange:s=>v({...i,childrenPercentage:Number(s.target.value)}),className:"bg-white"}),e.jsx("span",{className:"font-bold text-gray-600",children:"%"})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Thường là 50%, 75% hoặc 100% giá người lớn."})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h4",{className:"font-medium text-sm text-gray-700 mb-2",children:"Tổng hợp Dịch vụ đã chọn:"}),e.jsxs("div",{className:"text-sm bg-white p-3 rounded border max-h-40 overflow-y-auto",children:[a.tour_services.length===0?e.jsx("span",{className:"text-gray-400",children:"Chưa chọn dịch vụ nào"}):a.tour_services.map((s,t)=>e.jsxs("div",{className:"flex justify-between py-1 border-b last:border-0 border-dashed",children:[e.jsx("span",{className:"truncate w-2/3",children:s.service_name}),e.jsx("span",{className:"font-medium",children:s.price_total.toLocaleString()})]},t)),e.jsxs("div",{className:"flex justify-between mt-2 pt-2 border-t font-bold text-blue-600",children:[e.jsx("span",{children:"Tổng tiền dịch vụ:"}),e.jsxs("span",{children:[u.totalServiceCost.toLocaleString()," đ"]})]})]})]})]}),e.jsxs("div",{className:"space-y-6 rounded-lg bg-green-50 p-4 border border-green-200 h-fit",children:[e.jsx("h3",{className:"font-semibold text-green-700 uppercase p-2 bg-green-100 rounded",children:"2. Bảng giá thành (Ước tính)"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Chi phí dịch vụ/khách:"}),e.jsxs("span",{className:"font-medium",children:[u.serviceCostPerPax.toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Chi phí Guide/khách:"}),e.jsxs("span",{className:"font-medium",children:[u.guideCostPerPax.toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Bảo hiểm:"}),e.jsxs("span",{className:"font-medium",children:[i.insurancePerPax.toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center p-2 bg-white rounded border border-gray-100",children:[e.jsx("span",{className:"font-semibold text-gray-700",children:"GIÁ VỐN/KHÁCH:"}),e.jsxs("span",{className:"font-bold text-gray-800",children:[u.baseCost.toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"+ Phí quản lý:"}),e.jsxs("span",{className:"font-medium",children:[i.managementFee.toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-gray-600",children:["+ Lợi nhuận (",i.profitMargin,"%):"]}),e.jsxs("span",{className:"font-medium",children:[(u.priceBeforeTax-u.costWithMgmt).toLocaleString()," đ"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-gray-600",children:["+ Thuế VAT (",i.taxRate,"%):"]}),e.jsxs("span",{className:"font-medium",children:[(u.finalPrice-u.priceBeforeTax).toLocaleString()," đ"]})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-lg font-bold text-blue-700",children:"GIÁ BÁN ĐỀ XUẤT:"}),e.jsx("span",{className:"text-2xl font-bold text-blue-700",children:u.finalPrice.toLocaleString()})]}),e.jsx("p",{className:"text-xs text-gray-500 mb-4 text-right",children:"(Đã làm tròn đến hàng nghìn)"}),e.jsxs(y,{type:"button",onClick:ge,className:"w-full bg-blue-600 hover:bg-blue-700",size:"lg",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Áp dụng giá này vào Form"]})]})]})]}),e.jsxs("div",{className:"mt-6 flex flex-col md:flex-row gap-6 items-end",children:[e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx(n,{className:"text-base",children:"Giá Người lớn"}),e.jsx(g,{type:"number",min:"0",value:a.price_adult,onChange:s=>c("price_adult",Number(s.target.value)),className:"text-lg font-bold text-green-700 mt-1"}),d.price_adult&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.price_adult})]}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsxs(n,{className:"text-base",children:["Giá Trẻ em (",i.childrenPercentage,"%)"]}),e.jsx(g,{type:"number",min:"0",value:a.price_children,onChange:s=>c("price_children",Number(s.target.value)),className:"text-lg font-bold text-green-700 mt-1"}),d.price_children&&e.jsx("p",{className:"mt-1 text-xs text-red-500",children:d.price_children})]})]})]})}),e.jsxs("div",{className:"sticky bottom-0 z-20 flex justify-between gap-4 border-t bg-white/95 p-4 shadow-lg backdrop-blur",children:[e.jsx(y,{type:"button",variant:"outline",size:"lg",onClick:()=>window.history.back(),className:"text-gray-500",children:"Hủy bỏ"}),e.jsxs("div",{className:"flex gap-4",children:[m>1&&e.jsxs(y,{type:"button",variant:"outline",size:"lg",onClick:pe,children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"})," Quay lại"]}),m<6?e.jsxs(y,{type:"button",size:"lg",onClick:Q,className:"bg-blue-600 hover:bg-blue-700",children:["Tiếp theo ",e.jsx(ze,{className:"ml-2 h-4 w-4"})]}):e.jsx(y,{type:"submit",disabled:!oe||H,size:"lg",className:"min-w-[200px] bg-green-600 hover:bg-green-700",children:H?"Đang xử lý...":e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-4 w-4"})," Cập Nhật Tour"]})})]})]})]})})]})}export{$s as default};
